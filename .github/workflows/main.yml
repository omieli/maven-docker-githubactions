name: Maven Package - Multi stage docker

on:
  [push]

permissions:
  contents: write
  pull-requests: write
  issues: write
  repository-projects: write
  
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      jar_version: ${{ steps.bump.outputs.jar_version }}

    steps:
    - uses: actions/checkout@v2

    - name: Bump jar version
      id: bump
      run: |
        POMPATH=myapp
        version=${{  var.JAR_VERSION  }}
        major=$(echo $version | cut -d. -f1)
        minor=$(echo $version | cut -d. -f2)
        patch=$(echo $version | cut -d. -f3)
        new_version="$major.$minor.$((patch + 1))"
        echo ${new_version}

    - name: Update MY_SECRET
      uses: actions/create-or-update-secret@v1
      with:
        name: JAR_VERSION
        value: ${new_version}
        repository-id: ${{ env.GITHUB_REPOSITORY_ID }}
        api-key: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Docker build
      run: |
        docker build . -t omeili/java-app:${{ steps.bump.outputs.jar_version }} -f DockerMultiStage
    - name: Login to DockerHub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: Docker push
      run: |
        docker push omeili/java-app:${{ steps.bump.outputs.jar_version }}
  run:
    runs-on: ubuntu-18.04
    needs: [build]

    steps:
    - name: Run container
      run: |
        docker run omeili/java-app:${{needs.build.outputs.jar_version}}
