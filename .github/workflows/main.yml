name: Maven Package - Multi stage docker

on:
  [push]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      jar_version: ${{ steps.bump.outputs.jar_version }}

    steps:
    - uses: actions/checkout@v2

    - name: Bump jar version
      id: bump
      run: |
        POMPATH=myapp
        version=$(cd $POMPATH && mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        major=$(echo $version | cut -d. -f1)
        minor=$(echo $version | cut -d. -f2)
        patch=$(echo $version | cut -d. -f3)
        new_version="$major.$minor.$((patch + 1))"
        mvn -f myapp/pom.xml versions:set -DnewVersion=$new_version
        echo ::set-output name=jar_version::${new_version}
    - name: Set up Git user
      run: |
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "GitHub Actions"

    - name: Commit and push changes
      uses: actions/git-client@v2
      with:
        args: |
          add myapp/pom.xml
          commit -m "Bump patch version to $new_version"
          push origin master
      env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Docker build
      run: |
        docker build . -t omeili/java-app:${{ steps.bump.outputs.jar_version }} -f DockerMultiStage
    - name: Login to DockerHub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: Docker push
      run: |
        docker push omeili/java-app:${{ steps.bump.outputs.jar_version }}
  run:
    runs-on: ubuntu-18.04
    needs: [build]

    steps:
    - name: Run container
      run: |
        docker run omeili/java-app:${{needs.build.outputs.jar_version}}
